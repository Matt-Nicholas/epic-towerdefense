<!DOCTYPE html>
<html lang="en">
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />
        <title>Tower Defense</title>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/phaser/2.0.6/phaser.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script type="text/javascript" src="js/Enemy.class.js"></script>
        <style>
            *{
                margin : 0;
            }
        </style>
        <script type="text/javascript" src="js/Tower.class.js"></script>
    </head>
    <body>
      <h1>Schmower Defense</h1>
    </body>
    <script type="text/javascript">
        var game = new Phaser.Game(1000, 640, Phaser.AUTO, 'gameContainer', {preload: preload, create: create, update: update, render: render});
        var tileSquare = 32;
        var playerHealth = 20;
        var map, layer;

        var path = [{x: 0, y: 3},{x: 1, y: 3},{x: 2, y: 3},{x:3, y:3},{x:4, y:3},{x:5, y:3},{x:6, y:3},{x:7, y:3},{x:8, y:3},{x:9, y:3},{x:10, y:3},{x:10, y:4},{x:10, y:5},{x:10, y:6},{x:11, y:6},{x:12, y:6},{x:13, y:6},{x:14, y:6},{x:15, y:6},{x:15, y:5},{x:15, y:4},{x:15, y:3},{x:16, y:3},{x:17, y:3},{x:18, y:3},{x:19, y:3},{x:20, y:3},{x:21, y:3},{x:22, y:3},{x:23, y:3},{x:23, y:4},{x:23, y:5},{x:23, y:6},{x:23, y:7},{x:23, y:8},{x:23, y:9},{x:23, y:10},{x:23, y:11},{x:22, y:11},{x:21, y:11},{x:20, y:11},{x:19, y:11},{x:18, y:11},{x:17, y:11},{x:16, y:11},{x:15, y:11},{x:14, y:11},{x:14, y:12},{x:13, y:12},{x:12, y:12},{x:11, y:12},{x:10, y:12},{x:9, y:12},{x:8, y:12},{x:8, y:11},{x:8, y:10},{x:8, y:9},{x:8, y:8},{x:7, y:8},{x:6, y:8},{x:5, y:8},{x:4, y:8},{x:3, y:8},{x:3, y:9},{x:3, y:10},{x:3, y:11},{x:3, y:12},{x:3, y:13},{x:3, y:14},{x:3, y:15},{x:4, y:15},{x:5, y:15},{x:6, y:15},{x:7, y:15},{x:8, y:15},{x:9, y:15},{x:10, y:15},{x:11, y:15},{x:12, y:15},{x:12, y:16},{x:12, y:17},{x:12, y:18},{x:12, y:19},{x:12, y:20}];


        var towers = [];
        var canAddTower = true;

        var button;
        var button2;

        var attackStat = 0;
        var speedStat = 0;

        var cash = 250;

        var bmpText;
        var towerStatsText;
        var attackText;
        var speedText;


        var towerSelected = "bitchin";
        var tileForbiden = ["9", "10"];

        var enemysAnimation = [{'name': 'chain', 'length': 1}];


        function preload() {

           game.load.bitmapFont('desyrel', 'assets/fonts/bitmapFonts/gem.png', 'assets/fonts/bitmapFonts/gem.xml');

            game.load.tilemap('level1', 'assets/maps/tower-defense.json', null, Phaser.Tilemap.TILED_JSON);
            game.load.image('tiles', 'assets/maps/map_tiles.png');

            game.load.image('meh', 'assets/sprites/tower-32.png');
            game.load.image('bitchin', 'assets/sprites/tower1-32.png');
            game.load.image('bullet', 'assets/sprites/bullet.png');
            /*
             * Enemy Preload
             */
             game.load.spritesheet('chain', 'assets/images/chain1.png', 32, 32, 1);

             game.load.spritesheet('button2', 'assets/sprites/tower-48.png', 48, 48);
             game.load.spritesheet('button', 'assets/sprites/tower1.png', 48, 71, 1);

        }

        function create() {

            /**
             * Init map
             */
            game.physics.startSystem(Phaser.Physics.ARCADE)
            game.world.setBounds(0, 0, 800, 640);

            map = game.add.tilemap('level1');
            map.addTilesetImage('Level1', 'tiles');
            layer = map.createLayer('Ground');
            layer.resizeWorld();
            //game.input.onDown.add(listener, this);
            /*
             * Tower
             */
             towers = game.add.group();
            game.physics.enable(towers, Phaser.Physics.ARCADE);

            /*
             * Towers Bullets
             */

             bmpText = game.add.bitmapText(800, 500, 'desyrel', 'Cash:', 24);

             towerStatsText = game.add.bitmapText(800, 300, 'desyrel', 'Tower:', 24);

             attackText = game.add.bitmapText(800, 350, 'desyrel', 'Attack:', 24);
             speedText = game.add.bitmapText(800, 400, 'desyrel', 'Speed:', 24);

             button = game.add.button(810, 10, 'button', bitchinTowerClick);
             button2 = game.add.button(810, 81, 'button2', mehTowerClick);

            bullets = game.add.group();
            bullets.enableBody = true;
            bullets.physicsBodyType = Phaser.Physics.ARCADE;
            bullets.createMultiple(30, 'bullet');
            bullets.setAll('anchor.x', 0.5);
            bullets.setAll('anchor.y', 1);
            bullets.setAll('outOfBoundsKill', true);
            bullets.setAll('checkWorldBounds', true);

            /*
             * Enemy
             */

             enemys = game.add.group();
             enemys.enableBody = true;
             enemys.physicsBodyType = Phaser.Physics.ARCADE;

             generateEnemy();

             game.input.onDown.add(listener, this);

        }

        function bitchinTowerClick() {
        canAddTower = true;
        towerSelected = "bitchin";
        attackStat = 5;
        speedStat = 10;
        }
        function mehTowerClick() {
          canAddTower = true;
          towerSelected = "meh";
          attackStat = 5;
          speedStat = 5;
        }

        function render() {

        }
        function update() {
          /*
          * Generate Enemy
          */
          enemys.forEach(function(enemy) {
            if(!(enemy === undefined)) {
              Enemy.prototype.moveElmt(enemy);
            }
          });

          towers.forEach(function(tower) {
            enemys.forEach(function(enemy) {
              Tower.prototype.fire(tower, enemy);
            })
          });

          game.physics.arcade.overlap(bullets, enemys, collisionHandler, null, this);

          //Cash

           bmpText.setText("Cash:" + cash);

           towerStatsText.setText("Tower:" +  towerSelected);

           attackText.setText("Attack:" + attackStat);

           speedText.setText("Speed:" + speedStat);

           // select

            towers.forEach(function(tower) {
                 tower.inputEnabled = true;

                if(tower.input.pointerDown()){
                  tower.aplha = 0.5;
                  console.log("working");
                  if (tower.type === "meh") {
                    speedStat = 5;
                    towerSelected = "meh";
                  } else if (tower.type == "bitchin"){
                    speedStat = 10;
                    towerSelected = "bitchin";
                  }
                }

              });

        }
        function listener(pointer) {


          if (canAddTower) {
              /*
               * Add tower
               */

              console.log("Add tower");

                  if( towerSelected == "meh" && cash > 49){
                    cash -= 50;
                    Tower.prototype.add(pointer);
                    canAddTower = false;
                  }
                  else if( towerSelected == "bitchin" && cash > 74){
                    cash -= 75;
                    Tower.prototype.add(pointer);
                    canAddTower = false;
                  }


          }

        }


        function collisionHandler(bullet, enemy) {
            bullet.kill();
            Enemy.prototype.takeHit(enemy);
        }

        function generateEnemy() {
          var i = 0;
          var enemysBcl = setInterval(function() {
            if(i < 5) {
              var animEnemy = enemysAnimation[parseInt(Math.random() * enemysAnimation.length)];
              new Enemy(path[0].x * tileSquare, path[0].y * tileSquare, animEnemy.name, animEnemy.length);
            } else {
              clearTimeout(enemysBcl);
            }
            i++;
          }, 1000);
        }

        function takePlayerHit(enemy) {
          enemy.kill();
          enemy.destroy();
          this.enemys.remove(enemy)

          playerHealth -= 1;
        }



    </script>
</html>
